# Change Control Record: CR-010 — Fix CI Failures to Unblock PR #46

**Date**: 2026-02-06
**Author**: ODIN Agent
**Branch**: `feature/phase2-completion-sprint`
**PR**: #46
**Status**: Open

---

## Summary

PR #46 CI was failing on Lint and Type Check (blocking Build and Test). Root causes: ESLint `import/order` violations introduced by CR-008/CR-009 commits, missing `state` field in 46 test mocks from CR-008 AsyncState addition, pre-existing test DB isolation failure, and flaky Redis-dependent tests caused by inter-file state interference.

---

## Root Cause Breakdown

| # | Severity | Component | Root Cause | Origin |
|---|----------|-----------|------------|--------|
| 1 | BLOCKING | useRetry.ts | ESLint import ordering: `@ltip/shared` after `react` | CR-009 sleep dedup |
| 2 | BLOCKING | auth.service.ts, oauth.service.ts | ESLint import ordering: no newline between parent/sibling groups | CR-008 RBAC role import |
| 3 | BLOCKING | 3 page test files (46 mocks) | Missing `state: AsyncState` field in mock return values | CR-008 AsyncState addition |
| 4 | PRE-EXISTING | auth.lockout.test.ts | `prisma.user.create()` unique constraint violation on re-run | master (b479257) |
| 5 | PRE-EXISTING | accountLockout*.test.ts | Flaky failures from parallel file execution with shared Redis keys | master |

---

## Changes

### Fix 1: ESLint Import Ordering in useRetry.ts [BLOCKING]

**Problem**: `@ltip/shared` import placed after `react` import, empty line within import group.

**Solution**: Reorder imports: `@ltip/shared` before `react`, remove empty line within group.

**Files modified** (1):
- `apps/web/src/hooks/useRetry.ts`

### Fix 2: ESLint Import Ordering in auth/oauth Services [BLOCKING]

**Problem**: `../utils/roles.js` (parent group) and `./jwt.service.js` (sibling group) had no blank line between groups, violating `import/order` rule with `newlines-between: always`.

**Solution**: Add blank line between parent and sibling import groups.

**Files modified** (2):
- `apps/api/src/services/auth.service.ts`
- `apps/api/src/services/oauth.service.ts`

### Fix 3: Add Missing `state` Field to Test Mocks [BLOCKING]

**Problem**: CR-008 added `state: AsyncState<PaginatedResponse<T>>` to `UseBillsResult`, `UseLegislatorsResult`, and `UseVotesResult` return types. 46 `mockReturnValue` calls in 3 test files were not updated.

**Solution**: Added `state` field to each mock, derived from existing fields:
- `isLoading: true` -> `{ status: 'loading' }`
- `error: someError` -> `{ status: 'error', error: someError }`
- data present -> `{ status: 'success', data: { data: [...], pagination: {...} } }`
- otherwise -> `{ status: 'idle' }`

**Files modified** (3):
- `apps/web/src/app/bills/__tests__/BillsPageClient.test.tsx` (12 mocks)
- `apps/web/src/app/legislators/__tests__/LegislatorsPageClient.test.tsx` (15 mocks)
- `apps/web/src/app/votes/__tests__/VotesPageClient.test.tsx` (19 mocks)

### Fix 4: Use Upsert for Test User Creation [PRE-EXISTING]

**Problem**: `beforeEach` in auth.lockout.test.ts called `prisma.user.create()` with a fixed email. When `afterEach` cleanup fails, next run hits unique constraint violation, failing all 23 tests.

**Solution**: Replace `prisma.user.create()` with `prisma.user.upsert()` that resets all lockout fields.

**Files modified** (1):
- `apps/api/src/__tests__/services/auth.lockout.test.ts`

### Fix 5: Disable File Parallelism for API Tests [PRE-EXISTING]

**Problem**: `accountLockout.test.ts` and `accountLockout-race.test.ts` both clear all `lockout:*` Redis keys in `beforeEach`. When vitest runs files in parallel, one file's cleanup wipes another's state, causing flaky failures (different tests fail each run).

**Solution**: Set `fileParallelism: false` in API vitest config. Sequential file execution adds ~8s overhead but eliminates inter-file Redis state interference.

**Files modified** (1):
- `apps/api/vitest.config.ts`

---

## Commits

| Hash | Message |
|------|---------|
| `feecb7a` | fix(web): fix ESLint import ordering in useRetry.ts |
| `30a6831` | fix(web): add missing state field to page component test mocks |
| `bd18b3a` | fix(api): use upsert for test user creation in auth lockout tests |
| `8f19241` | fix(api): fix ESLint import ordering in auth and oauth services |
| `9a1c244` | fix(api): disable file parallelism to prevent Redis state interference |

---

## Test Results

### Before (at 36b6835, CI failing)
- Lint: 6 errors (FAIL)
- TypeCheck: 30+ errors (FAIL)
- Build: skipped
- Test: skipped (but locally 5 flaky failures in lockout tests)

### After (at 9a1c244)
- Lint: 0 errors, 18 warnings (PASS)
- TypeCheck: 0 errors (PASS)
- Build: all packages (PASS)
- API: 974/974 tests (PASS)
- Web: 606/606 tests (PASS)
- Shared: 84/84 tests (PASS)
- **Total: 1,664 tests passing**

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Import reorder changes runtime behavior | NONE | N/A | Import order has no runtime effect |
| Adding state field breaks existing test assertions | NONE | N/A | Additive field; no tests assert on it |
| Upsert changes test semantics | LOW | LOW | Reset clause ensures identical clean state |
| Sequential file execution hides parallelism bugs | LOW | MEDIUM | Only test-runner ordering; production code unaffected |
| Sequential adds CI time | LOW | LOW | ~8s overhead on 42 files; negligible |

---

## Rollback Plan

Each commit is independently revertable in reverse order:

1. Revert `9a1c244` — vitest parallelism (restore default parallel execution)
2. Revert `8f19241` — API import ordering (restore blank line positions)
3. Revert `bd18b3a` — upsert fix (restore prisma.user.create)
4. Revert `30a6831` — state field mocks (remove state from 46 mocks)
5. Revert `feecb7a` — useRetry import ordering (restore prior import order)
