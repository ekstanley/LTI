# Change Control Record: CR-010 — Fix CI Failures to Unblock PR #46

**Date**: 2026-02-06
**Author**: ODIN Agent
**Branch**: `feature/phase2-completion-sprint`
**PR**: #46
**Status**: Complete — CI GREEN

---

## Summary

PR #46 CI was failing on all checks (Lint, Type Check, Build, Test). Root causes spanned five categories: ESLint `import/order` violations from CR-008/CR-009, missing `state` field in 46 test mocks from CR-008 AsyncState addition, pre-existing test DB isolation failures, flaky Redis tests from inter-file state interference, and CI workflow gaps (missing Prisma generate, wrong env var scope, Turbo v2 strict env filtering).

---

## Root Cause Breakdown

| # | Severity | Component | Root Cause | Origin |
|---|----------|-----------|------------|--------|
| 1 | BLOCKING | useRetry.ts | ESLint import ordering: `@ltip/shared` after `react` | CR-009 sleep dedup |
| 2 | BLOCKING | auth.service.ts, oauth.service.ts | ESLint import ordering: no newline between parent/sibling groups | CR-008 RBAC role import |
| 3 | BLOCKING | 3 page test files (46 mocks) | Missing `state: AsyncState` field in mock return values | CR-008 AsyncState addition |
| 4 | PRE-EXISTING | auth.lockout.test.ts | `prisma.user.create()` unique constraint violation on re-run | master (b479257) |
| 5 | PRE-EXISTING | accountLockout*.test.ts | Flaky failures from parallel file execution with shared Redis keys | master |
| 6 | CI-INFRA | @ltip/shared build | `AbortSignal`/`setTimeout` types missing — no `@types/node` in shared | CR-009 sleep dedup |
| 7 | CI-INFRA | CI Lint job | 951 `no-unsafe-*` errors — missing `db:generate` + shared build steps | Pre-existing (masked by prior CI structure) |
| 8 | CI-INFRA | CI Test job | `DATABASE_URL` not reaching test processes — env at step level, no `db:push` | Pre-existing CI config gap |
| 9 | CI-INFRA | turbo.json | Turbo v2 strict env mode filtered `DATABASE_URL`/`REDIS_URL` from test task | Pre-existing turbo.json config |

---

## Changes

### Fix 1: ESLint Import Ordering in useRetry.ts [BLOCKING]

**Problem**: `@ltip/shared` import placed after `react` import, empty line within import group.

**Solution**: Reorder imports: `@ltip/shared` before `react`, remove empty line within group.

**Files modified** (1):
- `apps/web/src/hooks/useRetry.ts`

### Fix 2: ESLint Import Ordering in auth/oauth Services [BLOCKING]

**Problem**: `../utils/roles.js` (parent group) and `./jwt.service.js` (sibling group) had no blank line between groups, violating `import/order` rule with `newlines-between: always`.

**Solution**: Add blank line between parent and sibling import groups.

**Files modified** (2):
- `apps/api/src/services/auth.service.ts`
- `apps/api/src/services/oauth.service.ts`

### Fix 3: Add Missing `state` Field to Test Mocks [BLOCKING]

**Problem**: CR-008 added `state: AsyncState<PaginatedResponse<T>>` to `UseBillsResult`, `UseLegislatorsResult`, and `UseVotesResult` return types. 46 `mockReturnValue` calls in 3 test files were not updated.

**Solution**: Added `state` field to each mock, derived from existing fields:
- `isLoading: true` -> `{ status: 'loading' }`
- `error: someError` -> `{ status: 'error', error: someError }`
- data present -> `{ status: 'success', data: { data: [...], pagination: {...} } }`
- otherwise -> `{ status: 'idle' }`

**Files modified** (3):
- `apps/web/src/app/bills/__tests__/BillsPageClient.test.tsx` (12 mocks)
- `apps/web/src/app/legislators/__tests__/LegislatorsPageClient.test.tsx` (15 mocks)
- `apps/web/src/app/votes/__tests__/VotesPageClient.test.tsx` (19 mocks)

### Fix 4: Use Upsert for Test User Creation [PRE-EXISTING]

**Problem**: `beforeEach` in auth.lockout.test.ts called `prisma.user.create()` with a fixed email. When `afterEach` cleanup fails, next run hits unique constraint violation, failing all 23 tests.

**Solution**: Replace `prisma.user.create()` with `prisma.user.upsert()` that resets all lockout fields.

**Files modified** (1):
- `apps/api/src/__tests__/services/auth.lockout.test.ts`

### Fix 5: Disable File Parallelism for API Tests [PRE-EXISTING]

**Problem**: `accountLockout.test.ts` and `accountLockout-race.test.ts` both clear all `lockout:*` Redis keys in `beforeEach`. When vitest runs files in parallel, one file's cleanup wipes another's state, causing flaky failures (different tests fail each run).

**Solution**: Set `fileParallelism: false` in API vitest config. Sequential file execution adds ~8s overhead but eliminates inter-file Redis state interference.

**Files modified** (1):
- `apps/api/vitest.config.ts`

### Fix 6: Add @types/node to Shared Package [CI-INFRA]

**Problem**: `sleep()` function in `@ltip/shared` uses `AbortSignal`, `setTimeout`, `clearTimeout` — Node.js globals. Shared package tsconfig uses `lib: ["ES2022"]` without Node types. Built fine locally (ambient `@types/node` from hoisted deps) but failed in CI clean install.

**Solution**: Add `@types/node@^22.10.0` as explicit devDependency in shared package.

**Files modified** (1):
- `packages/shared/package.json` (+ `pnpm-lock.yaml`)

### Fix 7: Add Prisma Generate and Shared Build to Lint Job [CI-INFRA]

**Problem**: CI Lint job ran ESLint without generating the Prisma client or building shared packages. All `@prisma/client` imports resolved to `any`, triggering 951 `no-unsafe-*` lint errors. Pre-existing on master (942 errors) but masked because CI was structured differently before.

**Solution**: Add `db:generate` and `pnpm --filter @ltip/shared build` steps to Lint CI job.

**Files modified** (1):
- `.github/workflows/ci.yml`

### Fix 8: Fix Test Job Database Configuration [CI-INFRA]

**Problem**: Test job had `DATABASE_URL` at step level (only visible to "Run tests" step). Prisma client initializes at module load, and the `db:push` step also needed the URL. Additionally, no `db:push` or shared build steps existed.

**Solution**: Move env vars (`DATABASE_URL`, `REDIS_URL`, `NODE_ENV`) to job level. Add `db:push` and shared build steps.

**Files modified** (1):
- `.github/workflows/ci.yml`

### Fix 9: Add DATABASE_URL/REDIS_URL to Turbo Test Task Env [CI-INFRA]

**Problem**: Turbo v2.8.0 uses strict environment mode by default. The test task in `turbo.json` only declared `env: ["CI", "NODE_ENV"]`. Turbo filtered `DATABASE_URL` from the subprocess, causing `config.ts` Zod default (`ltip_dev`) to override the CI job-level value (`ltip_test`). `REDIS_URL` worked by coincidence (default `redis://localhost:6379` matched CI).

**Solution**: Add `DATABASE_URL` and `REDIS_URL` to test task's `env` array in `turbo.json`.

**Files modified** (1):
- `turbo.json`

---

## Commits

| Hash | Message |
|------|---------|
| `feecb7a` | fix(web): fix ESLint import ordering in useRetry.ts |
| `30a6831` | fix(web): add missing state field to page component test mocks |
| `bd18b3a` | fix(api): use upsert for test user creation in auth lockout tests |
| `8f19241` | fix(api): fix ESLint import ordering in auth and oauth services |
| `9a1c244` | fix(api): disable file parallelism to prevent Redis state interference |
| `1219edb` | fix(shared): add @types/node for sleep() globals in CI |
| `6d37959` | fix(ci): add Prisma generate and shared build to Lint job |
| `67c02bd` | fix(ci): add database schema push and shared build to Test job |
| `1c3d6d2` | fix(ci): add DATABASE_URL and REDIS_URL to turbo test task env |

---

## Test Results

### Before (at 36b6835, CI failing)
- Lint: 951+ errors (FAIL)
- TypeCheck: 30+ errors (FAIL)
- Build: skipped (blocked by Lint/TypeCheck)
- Test: skipped (blocked by Build)

### After (at 1c3d6d2, CI run 21774332892)
- Lint: 0 errors, 18 warnings (PASS)
- TypeCheck: 0 errors (PASS)
- Build: all packages (PASS)
- Test: all packages (PASS)
  - API: 974/974 tests
  - Web: 606/606 tests
  - Shared: 84/84 tests
  - **Total: 1,664 tests passing**

---

## Risk Assessment

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Import reorder changes runtime behavior | NONE | N/A | Import order has no runtime effect |
| Adding state field breaks existing test assertions | NONE | N/A | Additive field; no tests assert on it |
| Upsert changes test semantics | LOW | LOW | Reset clause ensures identical clean state |
| Sequential file execution hides parallelism bugs | LOW | MEDIUM | Only test-runner ordering; production code unaffected |
| Sequential adds CI time | LOW | LOW | ~8s overhead on 42 files; negligible |
| Adding @types/node widens available types | NONE | N/A | Only in devDependencies; doesn't affect runtime |
| Turbo env change affects cache invalidation | LOW | LOW | Test caches bust on DATABASE_URL change; correct behavior |

---

## Rollback Plan

Each commit is independently revertable in reverse order:

1. Revert `1c3d6d2` — turbo env (remove DATABASE_URL/REDIS_URL from test env)
2. Revert `67c02bd` — CI Test job (remove db:push, move env to step level)
3. Revert `6d37959` — CI Lint job (remove db:generate and shared build)
4. Revert `1219edb` — @types/node (remove from shared devDeps)
5. Revert `9a1c244` — vitest parallelism (restore default parallel execution)
6. Revert `8f19241` — API import ordering (restore blank line positions)
7. Revert `bd18b3a` — upsert fix (restore prisma.user.create)
8. Revert `30a6831` — state field mocks (remove state from 46 mocks)
9. Revert `feecb7a` — useRetry import ordering (restore prior import order)
