# Change Record: CR-2026-02-04-003

**Change ID**: CR-2026-02-04-003
**Date**: 2026-02-04
**Category**: Category 2 (Standard Changes - Team Approval)
**Status**: Completed
**Related Branch**: fix/ci-lint-errors (continuation)

---

## Summary

Resolved Next.js webpack module resolution failure preventing Bills, Legislators, and Votes pages from loading. Also fixed a validation test/schema mismatch.

---

## Problem Statement

### Primary Issue: ESM Module Resolution Failure

The Next.js frontend failed to resolve module imports from the `@ltip/shared` package when navigating to data-heavy pages (Bills, Legislators, Votes).

**Error Message**:
```
Module not found: Can't resolve './types/index.js'
...packages/shared/src/index.ts:11:1
```

**Import Trace**:
```
BillCard.tsx -> bills/index.ts -> BillsPageClient.tsx
BiasSpectrum.tsx -> bills/index.ts -> BillsPageClient.tsx
```

**User Impact**: Pages displayed loading spinner indefinitely with 500 errors.

### Secondary Issue: Test/Schema Mismatch

`BillFilters.test.tsx` expected validation message "500 characters" but schema used "200 characters".

---

## Root Cause Analysis

### ESM Resolution Issue

**Technical Cause**:
- `transpilePackages: ['@ltip/shared']` in `next.config.js` caused webpack to process TypeScript source directly
- The shared package uses ESM `.js` extensions in imports (e.g., `from './types/index.js'`)
- This is standard TypeScript ESM practice - compile to JS then reference the output extension
- Webpack couldn't resolve `.js` imports to `.ts` source files without `extensionAlias` configuration

**Why It Wasn't Detected Earlier**:
- Build process (`pnpm build`) pre-compiles to `dist/` where `.js` files exist
- Development mode with `transpilePackages` bypasses `dist/` and reads source directly
- Previous sessions may have had stale builds masking the issue

### Test Mismatch

**Technical Cause**: Validation schema was updated from 500 to 200 character limit, but test assertion wasn't updated.

---

## Changes Implemented

### Files Modified

1. **`apps/web/next.config.js`** (ESM fix)
   ```javascript
   webpack: (config) => {
     config.resolve.extensionAlias = {
       '.js': ['.ts', '.tsx', '.js', '.jsx'],
       '.mjs': ['.mts', '.mjs'],
     };
     return config;
   },
   ```

2. **`apps/web/src/components/__tests__/BillFilters.test.tsx`** (Test fix)
   - Line 225: Changed `/cannot exceed 500 characters/i` to `/cannot exceed 200 characters/i`

---

## Testing & Verification

### Pre-Change Status
- Homepage: HTTP 200
- Bills page: HTTP 500 (Module not found)
- Legislators page: HTTP 500 (Module not found)
- Votes page: HTTP 500 (Module not found)

### Post-Change Status
- Homepage: HTTP 200
- Bills page: HTTP 200 (5 bills displayed with real data)
- Legislators page: HTTP 200 (4 legislators displayed)
- Votes page: HTTP 200 (1 roll call vote displayed)

### Test Suite Results

| Package | Tests Passed | Tests Failed | Notes |
|---------|-------------|--------------|-------|
| @ltip/shared | 79/79 | 0 | 100% pass |
| @ltip/api | 568/574 | 6 | Pre-existing Redis flaky tests |
| @ltip/web | 421/424 | 3 | Pre-existing useRetry timing tests |
| **Total** | **1068/1077** | **9** | 99.2% pass rate |

### Pre-Existing Test Failures (Not Related to This Change)

**API Package (6 failures)**:
- `accountLockout.test.ts` - IP lockout across username changes (Redis state)
- `accountLockout.test.ts` - Username lockout across IP changes (Redis state)
- `accountLockout.test.ts` - Progressive backoff 6-hour lockout (timing)
- `accountLockout-race.test.ts` - Race condition prevention (Redis atomicity)
- `accountLockout-race.test.ts` - Maintain lockout state (state persistence)

**Web Package (3 failures)**:
- `useRetry.test.ts` - Reset retry state (timing/state management)

These failures exist independently of this change and require separate investigation.

---

## Risk Assessment

**Risk Level**: Low

**Technical Debt**: None introduced

**Mitigations**:
- Webpack `extensionAlias` is a standard, documented configuration
- No breaking changes to runtime behavior
- Test fix aligns test with actual schema

**Rollback Plan**: Remove `extensionAlias` webpack config if issues arise

---

## Dependencies & Impact

**Affected Components**:
- Next.js webpack configuration
- Module resolution for @ltip/shared imports
- Bills, Legislators, Votes pages

**Breaking Changes**: None

**Downstream Dependencies**: None

---

## Acceptance Criteria

- [x] Homepage loads successfully (HTTP 200)
- [x] Bills page displays real data (HTTP 200, 5 bills visible)
- [x] Legislators page displays real data (HTTP 200, 4 legislators visible)
- [x] Votes page displays real data (HTTP 200, 1 vote visible)
- [x] Shared package tests pass (79/79)
- [x] BillFilters tests pass (15/15)
- [x] No new test failures introduced
- [x] Change control documented

---

## Verification Evidence

### API Responses Verified
```bash
curl -s http://localhost:4000/api/health  # {"status":"ok"}
curl -s http://localhost:3000/bills       # HTTP 200
curl -s http://localhost:3000/legislators # HTTP 200
curl -s http://localhost:3000/votes       # HTTP 200
```

### Server Logs Confirmed
```
GET /bills 200 in 530ms
GET /legislators 200 in 155ms
GET /votes 200 in 186ms
```

---

## Lessons Learned

1. **ESM `.js` Extension Convention**: TypeScript ESM modules use `.js` extensions in imports even for `.ts` source files - this is the correct pattern per TS documentation
2. **`transpilePackages` Behavior**: Next.js `transpilePackages` reads source directly, bypassing `dist/` - requires `extensionAlias` for ESM TypeScript
3. **Test/Schema Sync**: Validation limits should be constants exported from shared package, used by both runtime code and tests

---

## Approvals

**Technical Lead**: _Pending Review_
**Team Review**: _Pending Review_

---

## Related Documentation

- Previous Change: CR-2026-02-01-002 (ESLint fixes)
- Next.js Config: apps/web/next.config.js
- Shared Package: packages/shared/src/index.ts
