# CR-010: k6 Load Test Scripts for API Performance Testing

**Date**: 2026-02-04
**Status**: Completed
**Priority**: P3
**Related Issue**: #9 ([P3-PERFORMANCE] Create k6 Load Test Scripts)
**Branch**: `feature/issue-9-k6-load-tests`

---

## Summary

Created comprehensive k6 load test scripts covering all 22 API endpoints across 6 resource domains (Bills, Legislators, Votes, Conflicts, Auth, Analysis). Fixed critical URL prefix bug and auth.js scope error discovered during validation.

---

## Changes

### New Files (committed at 40beb16)

| File | Description | Endpoints Covered |
|------|-------------|-------------------|
| `tests/performance/bills.js` | Bills API load test | 7 endpoints (list, detail, sponsors, cosponsors, actions, text, related) |
| `tests/performance/legislators.js` | Legislators API load test | 3 endpoints (list, detail, committees) |
| `tests/performance/votes.js` | Votes API load test | 3 endpoints (list, detail, breakdown) |
| `tests/performance/conflicts.js` | Conflicts API load test | 2 endpoints (list, detail) |
| `tests/performance/auth.js` | Auth API load test | 5 endpoints (register, login, refresh, logout, profile) |
| `tests/performance/analysis.js` | Analysis API load test | 2 endpoints (get, generate) |
| `tests/performance/BASELINE_METRICS.md` | Performance baseline targets | All endpoints documented |
| `tests/performance/README.md` | Usage documentation | Installation, profiles, CI/CD |

### Bug Fixes (committed at e021228)

1. **URL Prefix Mismatch (P1)**
   - All k6 scripts (except auth.js) used `/api/{resource}` instead of `/api/v1/{resource}`
   - Every request would have returned 404 against the live API
   - Fixed across 5 JS files + BASELINE_METRICS.md (67 occurrences corrected)
   - `/api/health` correctly left unversioned

2. **auth.js `__ITER` Scope Error**
   - `__VU` and `__ITER` were read at module scope; these are k6 execution context variables only available inside the default VU function
   - Caused `ReferenceError: __ITER is not defined` at script parse time
   - Moved reads into `generateTestUser()` function body

### Additional Fix (committed at 37bfdde)

3. **BillFilters Test Alignment**
   - Test expected 500-char validation limit but shared Zod schema uses 200
   - Changed `'a'.repeat(501)` to `'a'.repeat(201)` and updated expected error message

---

## Test Coverage per Script

| Script | Load Profiles | Custom Metrics | Scenarios | Health Check |
|--------|--------------|----------------|-----------|--------------|
| bills.js | light/medium/heavy | 7 Trends, Rate, Counter | 4 weighted scenarios | Yes |
| legislators.js | light/medium/heavy | 3 Trends, Rate, Counter | 3 weighted scenarios | Yes |
| votes.js | light/medium/heavy | 3 Trends, Rate, Counter | 3 weighted scenarios | Yes |
| conflicts.js | light/medium/heavy | 2 Trends, Rate, Counter | 2 weighted scenarios | Yes |
| auth.js | light/medium/heavy | 5 Trends, Rate, Counter | 4 weighted scenarios | Yes |
| analysis.js | light/medium/heavy | 2 Trends, Rate, Counter | 2 weighted scenarios | Yes |

---

## Load Profile Details

| Profile | VU Ramp | Duration | Use Case |
|---------|---------|----------|----------|
| light | 5-10 VUs | ~1 min | Development smoke tests |
| medium | 20-50 VUs | ~2 min | CI/CD regression testing |
| heavy | 50-100 VUs | ~3 min | Capacity planning |

---

## Validation

- All 6 scripts pass `k6 inspect` (syntax/parse validation)
- All URL prefixes verified: 0 unversioned API paths, 67 correct `/api/v1/` occurrences
- Baseline execution blocked by API server import error (`@ltip/shared/validation` export issue)
- Web tests: 424/424 passing (100%)

---

## Acceptance Criteria Status (Issue #9)

| Criteria | Status | Notes |
|----------|--------|-------|
| Homepage load test | N/A | Not applicable (frontend, not API) |
| Bill listing API load test | Done | bills.js covers 7 endpoints with throughput metrics |
| Search API load test | Done | Covered via bills.js search parameter scenarios |
| Authentication flow stress test | Done | auth.js covers full auth lifecycle |
| WebSocket connection test | Pending | Requires WebSocket infrastructure (not yet implemented) |
| Success rate, response time, throughput metrics | Done | Custom Trends, Rates, Counters per endpoint |
| Grafana dashboard | Pending | Requires Grafana + k6 Cloud/InfluxDB setup |
| CI/CD integration | Documented | README.md includes GitHub Actions workflow example |

---

## Commits

| Hash | Type | Description |
|------|------|-------------|
| `40beb16` | test | Add k6 load test scripts for 22 API endpoints |
| `37bfdde` | fix | Align BillFilters validation test with 200-char shared schema |
| `e021228` | fix | Correct k6 load test URL prefixes and auth.js scope error |

---

## Screenshots

| Page | File | Description |
|------|------|-------------|
| Homepage | `docs/screenshots/01-homepage.png` | Landing page with feature cards and stats |
| Bills | `docs/screenshots/02-bills-page.png` | Bills page with filters and error state (API down) |
| Legislators | `docs/screenshots/03-legislators-page.png` | Legislators page with chamber/party/state filters |
| Votes | `docs/screenshots/04-votes-page.png` | Live votes page with chamber/result filters |

---

## Risk Assessment

| Risk | Severity | Mitigation |
|------|----------|------------|
| API server not running (import error) | Medium | Baselines pending; scripts validated via k6 inspect |
| Test data uses sample IDs that may not exist | Low | Scripts handle 404s gracefully |
| Conflicts/Analysis APIs not implemented | Low | Scripts test current behavior (empty/404 responses) |

---

**Author**: ODIN Agent (Issue #9 - Performance Testing)
**Reviewer**: Pending
